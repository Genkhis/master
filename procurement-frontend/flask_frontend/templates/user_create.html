{% extends "base.html" %}
{% set edit_mode = request.args.get('id') %}
{% block title %}{{ "Benutzer bearbeiten" if edit_mode else "Neuer Benutzer" }}{% endblock %}

{% block content %}
<h3 class="mb-4">{{ "Benutzer bearbeiten" if edit_mode else "Neuer Benutzer" }}</h3>

<form id="user-form" class="col-md-4">
    <div class="mb-3">
        <label class="form-label">E-Mail</label>
        <input id="email" type="email" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Passwort</label>
        <input id="password" type="password" class="form-control"
               {{ "" if edit_mode else "required" }}>
        <small class="text-muted">{{ "Leer lassen zum Beibehalten" if edit_mode else "" }}</small>
    </div>

    <div class="form-check mb-3">
        <input id="super" class="form-check-input" type="checkbox">
        <label class="form-check-label">Superuser</label>
    </div>

    <button id="save-btn" class="btn btn-primary">
        <span id="spinner" class="spinner-border spinner-border-sm d-none"></span>
        Speichern
    </button>
</form>

<div id="form-error" class="alert alert-danger d-none mt-3"></div>
{% endblock %}

{% block script %}
<script>
/* ── small helpers ───────────────────────────────────────────── */
const API_URL = "{{ API_URL }}";
const $       = sel => document.querySelector(sel);
function authHeader() {
  const match = document.cookie.split(';')
        .find(c => c.trim().startsWith('bearer='));
  if (!match) return {};
  return { Authorization: `Bearer ${match.split('=')[1]}` };
}
/* ────────────────────────────────────────────────────────────── */

const id      = new URLSearchParams(location.search).get('id');
const apiBase = `${API_URL}/users`;

if (id) {                      // ----- edit: pre-fill -----
  fetch(`${apiBase}/${id}`, { headers: authHeader() })
    .then(r => r.json())
    .then(u => {
       $('#email').value   = u.email;
       $('#super').checked = u.is_superuser;
    });
}

$('#user-form').addEventListener('submit', ev => {
  ev.preventDefault();
  $('#spinner').classList.remove('d-none');
  $('#save-btn').disabled = true;
  $('#form-error').classList.add('d-none');

  const payload = {
    email        : $('#email').value.trim(),
    password     : $('#password').value.trim() || undefined,
    is_active    : true,
    is_superuser : $('#super').checked,
    is_verified  : true,
    roles        : []
  };

  const method = id ? 'PATCH' : 'POST';
  const url    = id ? `${apiBase}/${id}` : apiBase;

  fetch(url, {
      method,
      headers: { ...authHeader(), 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
  })
  .then(r => {
      if (!r.ok) {
        return r.text().then(t => Promise.reject({code:r.status,msg:t}));
      }
      location.href = '{{ url_for("users") }}';
  })
  .catch(err => {
      $('#form-error').textContent =
         `Fehler ${err.code || ''} – ${err.msg || err}`;
      $('#form-error').classList.remove('d-none');
  })
  .finally(() => {
      $('#spinner').classList.add('d-none');
      $('#save-btn').disabled = false;
  });
});
</script>
{% endblock %}
