{% extends "base.html" %}
{% set edit_mode = request.args.get('id') %}
{% block title %}{{ "Benutzer bearbeiten" if edit_mode else "Neuer Benutzer" }}{% endblock %}

{% block content %}
<h3 class="mb-4">{{ "Benutzer bearbeiten" if edit_mode else "Neuer Benutzer" }}</h3>

<form id="user-form" class="col-md-4">
    <div class="mb-3">
        <label class="form-label">E-Mail</label>
        <input id="email" type="email" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Passwort</label>
        <input id="password" type="password" class="form-control"
               {{ "" if edit_mode else "required" }}>
        <small class="text-muted">
            {{ "Leer lassen zum Beibehalten" if edit_mode else "" }}
        </small>
    </div>

    <div class="form-check mb-3">
        <input id="super" class="form-check-input" type="checkbox">
        <label class="form-check-label">Superuser</label>
    </div>

    <button id="save-btn" class="btn btn-primary">
        <span id="spinner" class="spinner-border spinner-border-sm d-none"></span>
        Speichern
    </button>
</form>

<div id="form-error" class="alert alert-danger d-none mt-3"></div>
{% endblock %}

{% block script %}
<script>
const API_URL = "{{ API_URL }}";
const $ = s => document.querySelector(s);
function authHeader () {
  const m = document.cookie.split(';').find(c => c.trim().startsWith('bearer='));
  return m ? { Authorization: `Bearer ${m.split('=')[1]}` } : {};
}

const id      = new URLSearchParams(location.search).get('id');
const usersEP = `${API_URL}/users`;
const regEP   = `${API_URL}/auth/register`;

/* ----- edit mode: pre-fill data ----- */
if (id) {
  fetch(`${usersEP}/${id}`, { headers: authHeader() })
    .then(r => r.json())
    .then(u => {
        $('#email').value   = u.email;
        $('#super').checked = u.is_superuser;
    });
}

$('#user-form').addEventListener('submit', ev => {
  ev.preventDefault();
  $('#spinner').classList.remove('d-none');
  $('#save-btn').disabled = true;
  $('#form-error').classList.add('d-none');

  const createPayload = {
    email      : $('#email').value.trim(),
    password   : $('#password').value.trim() || "ChangeMe123!",
    is_active  : true,
    is_verified: true
  };

  const updatePayload = {
    password    : $('#password').value.trim() || undefined,
    is_superuser: $('#super').checked
  };

  /* ---------- new vs edit ---------- */
  const p = id
    ? fetch(`${usersEP}/${id}`, {
         method : 'PATCH',
         headers: { ...authHeader(), 'Content-Type': 'application/json' },
         body   : JSON.stringify(updatePayload)
       })
    : fetch(regEP, {
         method : 'POST',
         headers: { ...authHeader(), 'Content-Type': 'application/json' },
         body   : JSON.stringify({ ...createPayload,
                                   is_superuser: $('#super').checked })
       })
      /* /auth/register ignores is_superuser → optional follow-up PATCH */
      .then(r => r.ok ? r.json() : Promise.reject(r))
      .then(u => $('#super').checked
            ? fetch(`${usersEP}/${u.id}`, {
                  method : 'PATCH',
                  headers: { ...authHeader(), 'Content-Type': 'application/json' },
                  body   : JSON.stringify({ is_superuser: true })
              })
            : Promise.resolve());

  p.then(r => {
      if (r && !r.ok) {
         return r.text().then(t => Promise.reject({ code: r.status, msg: t }));
      }
      location.href = '{{ url_for("users") }}';
  })
  .catch(async err => {
      const txt = err.msg || (err.text ? await err.text() : err);
      $('#form-error').textContent = `Fehler ${err.code || ''} – ${txt}`;
      $('#form-error').classList.remove('d-none');
  })
  .finally(() => {
      $('#spinner').classList.add('d-none');
      $('#save-btn').disabled = false;
  });
});
</script>
{% endblock %}
