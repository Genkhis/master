{% extends "base.html" %}
{% block title %}Benutzerverwaltung{% endblock %}

{% block content %}
<h3 class="mb-4">Benutzer</h3>

<a href="{{ url_for('users_create') }}" class="btn btn-sm btn-success mb-3">
    <i class="bi bi-plus"></i> Neuer Benutzer
</a>

<table class="table table-sm table-hover" id="users-table">
    <thead><tr><th>E-Mail</th><th>Aktiv</th><th>Super</th><th>Aktion</th></tr></thead>
    <tbody></tbody>
</table>

<div id="u-error" class="alert alert-danger d-none mt-3"></div>
{% endblock %}

{% block script %}
<script>
const API_URL = "{{ API_URL }}";
const $ = s => document.querySelector(s);
function authHeader(){
  const m = document.cookie.split(';').find(c=>c.trim().startsWith('bearer='));
  return m ? {Authorization:`Bearer ${m.split('=')[1]}`} : {};
}

fetch(`${API_URL}/users`, { headers: authHeader() })
  .then(r => r.ok ? r.json() : Promise.reject(r))
  .then(users => {
      users.forEach(u => $('#users-table tbody').insertAdjacentHTML('beforeend', `
        <tr>
          <td>${u.email}</td>
          <td>${u.is_active ? "✅" : "❌"}</td>
          <td>${u.is_superuser ? "👑" : ""}</td>
          <td>
            <a href="{{ url_for('users_create') }}?id=${u.id}"
               class="btn btn-sm btn-outline-primary">Edit</a>
          </td>
        </tr>`));
  })
  .catch(async r => {
      $('#u-error').textContent = `Fehler ${r.status}: ${await r.text()}`;
      $('#u-error').classList.remove('d-none');
  });
</script>
{% endblock %}
