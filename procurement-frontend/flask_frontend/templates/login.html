{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-4">
        <h3 class="mb-3 text-center">Anmelden</h3>

        <form id="login-form" autocomplete="off">
            <div class="mb-3">
                <input type="email" class="form-control" id="email"
                       placeholder="E-Mail" required>
            </div>
            <div class="mb-3">
                <input type="password" class="form-control" id="password"
                       placeholder="Passwort" required>
            </div>

            <button class="btn btn-primary w-100" type="submit">
                <span id="login-spinner"
                      class="spinner-border spinner-border-sm d-none"></span>
                <span id="login-btn-text">Login</span>
            </button>
        </form>

        <div id="login-error" class="text-danger mt-3 d-none"></div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
(() => {
  const API     = "{{ API_URL }}";
  const nextUrl = new URLSearchParams(location.search).get("next") ||
                  "{{ url_for('index') }}";

  // optional: wake the Neon DB
  fetch(`${API}/wake_db`).catch(() => {});

  $('#login-form').on('submit', e => {
    e.preventDefault();

    $('#login-spinner').removeClass('d-none');
    $('#login-btn-text').text('Bitte warten â€¦');
    $('#login-error').addClass('d-none');

    $.ajax({
      type        : "POST",
      url         : `${API}/auth/jwt/login`,
      crossDomain : true,
      xhrFields   : { withCredentials: true },     // accept Set-Cookie
      /*  ðŸ”‘ SEND AS FORM DATA (default jQuery behaviour) */
      data        : {
        username : $('#email').val().trim(),
        password : $('#password').val().trim()
      },
      /*  FastAPI returns 204 No-Content; treat it as success              */
      statusCode  : { 204: () => window.location.replace(nextUrl) },
      error       : () => $('#login-error')
                        .text('Login fehlgeschlagen â€“ bitte prÃ¼fe E-Mail & Passwort.')
                        .removeClass('d-none'),
      complete    : () => {
        $('#login-spinner').addClass('d-none');
        $('#login-btn-text').text('Login');
      }
    });
  });
})();
</script>
{% endblock %}

