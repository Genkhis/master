{# ------------------------------------------------------------------------
   Login page â€” extends the base layout above
------------------------------------------------------------------------ #}
{% extends "base.html" %}

{% block title %}Login â€“ Beschaffungssystem{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-4">
        <h3 class="mb-3 text-center">Anmelden</h3>

        <form id="login-form" autocomplete="off" novalidate>
            <div class="mb-3">
                <input type="email"
                       id="email"
                       class="form-control"
                       placeholder="E-Mail"
                       required>
            </div>

            <div class="mb-3">
                <input type="password"
                       id="password"
                       class="form-control"
                       placeholder="Passwort"
                       required>
            </div>

            <button class="btn btn-primary w-100" type="submit">
                <span id="login-spinner"
                      class="spinner-border spinner-border-sm d-none"></span>
                <span id="login-btn-text">Login</span>
            </button>
        </form>

        <div id="login-error" class="text-danger mt-3 d-none"></div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * DEBUG fetch wrapper â€“ prints request, response and cookies
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function dbgFetch(url, opts) {
  console.groupCollapsed('[login] fetch', url);
  console.log('request', opts);
  const res = await fetch(url, opts);
  console.log('status', res.status, res.statusText);
  console.log('set-cookie header', res.headers.get('set-cookie'));
  console.log('document.cookie AFTER response â†’', document.cookie);
  console.groupEnd();
  return res;
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/

document.addEventListener('DOMContentLoaded', () => {
  const $       = sel => document.querySelector(sel);
  const API     = "{{ API_URL }}";
  const nextUrl = new URLSearchParams(location.search).get('next')
                || "{{ url_for('index') }}";

  $('#login-form')?.addEventListener('submit', async ev => {
    ev.preventDefault();

    $('#login-spinner').classList.remove('d-none');
    $('#login-btn-text').textContent = 'Bitte warten â€¦';
    $('#login-error').classList.add('d-none');

    const body = new URLSearchParams({
      username: $('#email').value.trim(),
      password: $('#password').value.trim()
    });

    try {
      /* ðŸ‘‰ use dbgFetch instead of fetch */
      const resp = await dbgFetch(`${API}/auth/jwt/login`, {
        method      : 'POST',
        mode        : 'cors',
        credentials : 'include',
        headers     : { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      if (!resp.ok) throw new Error('auth-failed');

      /* backend sets cookie â†’ go on */
      window.location.replace(nextUrl);

    } catch {
      const box = $('#login-error');
      box.textContent =
        'Login fehlgeschlagen â€“ bitte E-Mail & Passwort prÃ¼fen.';
      box.classList.remove('d-none');
    } finally {
      $('#login-spinner').classList.add('d-none');
      $('#login-btn-text').textContent = 'Login';
    }
  });
});
</script>
{% endblock %}

