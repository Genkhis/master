{% block script %}
<script>
(() => {
  // tiny helper for brevity
  const $ = sel => document.querySelector(sel);

  const API     = "{{ API_URL }}";
  const nextUrl = new URLSearchParams(location.search).get("next") ||
                  "{{ url_for('index') }}";

  $('#login-form').addEventListener('submit', async ev => {
    ev.preventDefault();

    $('#login-spinner').classList.remove('d-none');
    $('#login-btn-text').textContent = 'Bitte warten …';
    $('#login-error').classList.add('d-none');

    /* CookieTransport expects x-www-form-urlencoded */
    const body = new URLSearchParams({
      username: $('#email').value.trim(),
      password: $('#password').value.trim()
    });

    try {
      const resp = await fetch(`${API}/auth/jwt/login`, {
        method      : 'POST',
        mode        : 'cors',
        credentials : 'include',               // send + receive cookies
        headers     : { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });

      if (!resp.ok) throw new Error('auth-failed');   // 4xx / 5xx → catch

      /* 204 No Content on success; cookie “jwt” is now set */
      window.location.replace(nextUrl);

    } catch {
      $('#login-error').textContent =
        'Login fehlgeschlagen – bitte E-Mail & Passwort prüfen.';
      $('#login-error').classList.remove('d-none');
    } finally {
      $('#login-spinner').classList.add('d-none');
      $('#login-btn-text').textContent = 'Login';
    }
  });
})();
</script>
{% endblock %}
